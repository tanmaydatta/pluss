{% extends "base.html" %} {% load staticfiles %} {% block head %}

<head>
    <title>Template</title>
</head>
<link href="{% static 'datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'datatables-responsive/css/dataTables.responsive.css' %}" rel="stylesheet" type="text/css" />
<!-- new -->
<!-- Ionicons -->
<link href="{% static 'css/ionicons.min.css' %}" rel="stylesheet" type="text/css" />
<!-- bootstrap 3.0.2 -->
<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />
<link href="{%static 'css/skin-win8/ui.easytree.css' %}" rel="stylesheet" type="text/css" /> {% endblock %} {% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">FILE STRUCTURE</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                Choose where to put the content
            </div>
            <br>
            <br>
            <div class="panel-body">
                <div class="row">
                    <div class="col-lg-6">
                        <form role="form">
                            <div>
                                <div class="form-group">
                                    <!--class="box-body table-responsive"-->
                                    <select class="form-control" id="lstNodes" name="e_poster" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" style="width:80%;">
                                        <!-- <option value="select folder" selected>select folder</option>
                                                {% for file in folder_list %}
                                                <option id="{{file.id}}" style="text-align:center">{{ file.name }}</option>
                                                {% endfor %} -->
                                    </select>
                                    <br>
                                    <br>
                                    <button class="btn btn-primary btn-sm" onclick="addNode(); return false;">Add-Folder</button>
                                    <button class="btn btn-primary btn-sm" onclick="addNode1(); return false;">Add-Content</button>
                                    <button class="btn btn-warning btn-sm" onclick="removeNodeX(); return false;">Remove</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- /.col-lg-6 (nested) -->
                </div>
                <!-- /.row (nested) -->
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->
    </div>
    <!-- /.col-lg-12 -->
    <!--   Folder structure-->
    <div style="width:100%">
        <div style="float:left; width:60%">
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Folder Details</h4>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="dataTable_wrapper">
                                <table class="table table-striped table-bordered table-hover" id="example1">
                                    <thead>
                                        <tr>
                                            <th>Folder Name</th>
                                            <th>Select</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- details -->
                                        {% for folder in folder_list %}
                                        <tr>
                                            <th>{{folder.name}}</th>
                                            <th>
                                                <input type="checkbox" name="checkboxFolder" data-fid="{{folder.id}}" id="checkboxFolder" value="{{folder.name}}" />
                                            </th>
                                            <!-- <th><a href="#" onclick="return AddToThis({{folder.id}})"><i class="fa fa-plus"></i>Add</a></th> -->
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
        </div>
        <div style="float:right; width:40%">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        FILE STRUCTURE
                    </div>
                    <br>
                    <br>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <form role="form">
                                    <div>
                                        <div class="form-group">
                                            <div id="demo_menu"></div>
                                        </div>
                                        <div>
                                            <!-- <textarea id="textareaJson"></textarea> -->
                                            <button type="submit" class="btn btn-primary btn-success btn-sm" onClick="create_json_js()" value="create-json" name="submitJson">Create Template</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <!-- /.col-lg-6 (nested) -->
                        </div>
                        <!-- /.row (nested) -->
                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->
            </div>
            <!-- /.col-lg-12 -->
        </div>
    </div>
    <!-- /.row -->
</div>
<!--Content Structure -->
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>Content Details</h4>
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div class="dataTable_wrapper">
                    <table class="table table-striped table-bordered table-hover" id="example2">
                        <thead>
                            <tr>
                                <th>Content Name</th>
                                <th>Type</th>
                                <th>Select</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- details -->
                            {% for content in content_list %}
                            <tr>
                                <th id="cname">{{content.name}}</th>
                                <th>{{content.type}}</th>
                                <th>
                                    <input data-content-type="{{content.type}}" type="checkbox" data-cid="{{content.id}}" id="checkboxContent" value="{{content.name}}" name="checkboxContent" />
                                </th>
                                <!-- <th><a href="#" onclick="return AddToThis({{content.id}})"><i class="fa fa-plus"></i>Add</a></th> -->
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- /.table-responsive -->
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->
    </div>
    <!-- /.col-lg-12 -->
</div>
{% endblock %} {% block scripts %}
<script src="{% static 'js/jquery.dataTables.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/dataTables.bootstrap.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/jquery.easytree.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/jquery.cookie.js' %}" type="text/javascript"></script>
<script>
$(document).ready(function() {
    $('.table').DataTable({
        responsive: true
    });
});


var item_data = {};
item_data["template"] = {};
//item_data["template"]["id"]="10";
// item_data["template"]["id"] = "{{folder.id}}";
// item_data["template"]["file-structure"] = {};
//----iterative function for json when folder select

function iterate(obj, val, arr) {
    console.log(val);
    console.log(arr);
    var flag = false;
    for (var key in obj) {
        if (key == val) {
            flag=1;
            for (var j = 0; j < arr.length; j++) {
                // var key1 = arr[j];
                // for (var o in key1) {
                    // if (key1.hasOwnProperty(o)) {
                        // console.log(arr[j]);
                        // console.log(obj[val]);
                        obj[val][arr[j]]={};
                        // obj[key]["content"][o]["type"] = "folder";
                        // obj[key]["content"][o]["content"] = {};
                    // }
                // }
            }
            // break;
            // return ;
            return true;
        }
        else
        {
            flag = flag || iterate(obj[key],val,arr);
        }
         //if (typeof elem === "object") { // is an object (plain object or array)// so contains children
          // iterate(elem, val, arr); // call recursively              
        // }
    }

    if (!flag)
    {
        for (var j = 0; j < arr.length; j++) {
                obj[arr[j]]={};
        }
    }
}

//----iterative function for json when folder select
function iterate1(obj, val, arr) {
    // console.log(val);
    // console.log(arr);
    var flag=false;
    for (var key in obj) {
        console.log(key);
        if (key == val) {
            // for (var j = 0; j < arr.length; j++) {
                // var key1 = arr[j];
                // for (var o in key1) {
                    // if (key1.hasOwnProperty(o)) {
                        // var split = key1;
                        obj[val]['content']=arr;
                        // obj[key]["content"][key1[0]]["type"] = "file";
                    // }
                // }
                return true;
            }
            else
            {
                flag =flag ||  iterate1(obj[key],val,arr);
            }
        }
       // if (typeof elem === "object") { // is an object (plain object or array)// so contains children
    // if (!flag)
    // {
        // for (var j = 0; j < arr.length; j++) {
                // obj['content']=arr;
        // }
    // }   //    iterate1(elem, val, arr); // call recursively              
        
}


function removeJsonObj(obj, str_remove) {

    for (var key in obj) {
        var elem = obj[key]; // `obj[key]` is the value                
        if (key == str_remove) {
            console.log(key + "--------" + str_remove);
            delete obj[key];
            //var jsonString1 = JSON.stringify(item_data);
            //console.log("jsonString1="+jsonString1);                       
        }
        if (typeof elem === "object") { // is an object (plain object or array)// so contains children
            removeJsonObj(elem, str_remove); // call recursively              
        }
    }
}

function loadTable(arr_non_select_folder, arr_select_folder_nonfid) {

    var str_tbl_body = "";
    $("#example1 tbody").html("");
    for (var i = 0; i < arr_non_select_folder.length; i++) {
        var key = arr_non_select_folder[i];
        // for (var o in key) 
        // {
        //     if (key.hasOwnProperty(o)) 
        //     {                         
        str_tbl_body += '<tr><td>' + key + '</td><td><input type="checkbox" name="checkboxFolder" id="checkboxFolder" data-fid="'+arr_select_folder_nonfid[i] +'" value="' + key + '" /></td></tr>';
        // }
        //}
    }
    $("#example1 tbody").html(str_tbl_body);
}
// function preLoadFolderContentTable(arr_non_select_folder)
// {                i]

//     var str_tbl_body="";                
//     var str_tbl_body1="";
//     for (var i = 0; i<arr_non_select_folder.length;i++)
//     {   
//         var key = arr_non_select_folder[i];
//          for (var o in key) 
//          {
//              if (key.hasOwnProperty(o)) 
//              {                            

//                 if(key.indexOf("pp-folder")!=-1)
//                 {
//                     str_tbl_body+='<tr><td>'+key+'</td>'+'<td>'++'</td>'+'<td><input type="checkbox" name="checkboxFolder" id="checkboxFolder" value="'+o+'||::||~||::||'+key[o]+'" /></td></tr>';
//                 }
//                 else if(o.indexOf("pp-content")!=-1)
//                 {
//                    var split=o.split('||::||~||::||'); 
//                    var str_content_type;
//                    if(split[1]==1)
//                    {
//                         str_content_type="Movies";
//                    }
//                    else if(split[1]==2)
//                    {
//                         str_content_type="Songs";
//                    }
//                    else if(split[1]==3)
//                    {
//                         str_content_type="Videos";
//                    }
//                    else
//                    {
//                     str_content_type="-----------";
//                    }
//                     str_tbl_body1+='<tr><td>'+key[o]+'</td><td>'+str_content_type+'</td><td><input type="checkbox" value="'+split[0]+key[o]+split[1]+'" id="checkboxContent" name="checkboxContent"/></td></tr>';
//                // }
//             //}
//         }
//     }                
//     $("#example1 tbody").append(str_tbl_body);
//     $("#example2 tbody").append(str_tbl_body1);
// }
function loadTableContent(arr_content, arr_content_type, arr_select_content_noncid) {
    var str_tbl_body = "";
    $("#example2 tbody").html("");
    for (var i = 0; i < arr_content.length; i++) {
        var split2 = arr_content_type[i];
        var str_content_type;
        if (split2 == "SONG") {
            str_content_type = "SONG";
        } else if (split2 == "MOVIE") {
            str_content_type = "MOVIE";
        } else if (split2 == "VIDEO") {
            str_content_type = "VIDEO";
        }
        if (split2 == "") {
            str_content_type = "-----------";
        }
        str_tbl_body += '<tr><td>' + arr_content[i] + '</td><td>' + str_content_type + '</td><td><input type="checkbox" data-content-type="' + str_content_type + '" name="checkboxContent" data-cid="'+arr_select_content_noncid[i]+'" id="checkboxContent" value="' + arr_content[i] + '" /></td></tr>';
    }
    $("#example2 tbody").html(str_tbl_body);
}

function addNode() {
    var arr_select_folder = [];
    var arr_non_select_folder = [];
    var arr_select_folder_fid = [];
    var arr_select_folder_nonfid = [];

    $('input:checkbox[name=checkboxFolder]:checked').each(function() {
        var newElement = $(this).val();
        var newElement_fid = $(this).attr('data-fid');
        // newElement[split1[0]]=split1[1];
        arr_select_folder.push(newElement);
        arr_select_folder_fid.push(newElement_fid);
    });
    //console.log(arr_select_folder)               
    $('input:checkbox[name=checkboxFolder]:not(:checked)').each(function() {
        // var split2=$(this).val().split('||::||~||::||'); 
        var newElement2 = $(this).val();
        var newElement_nonfid=$(this).attr('data-fid');
        arr_non_select_folder.push(newElement2);
        arr_select_folder_nonfid.push(newElement_nonfid);
    });

    for (var i = 0; i < arr_select_folder.length; i++) {
        var key = arr_select_folder[i];

        // for (var o in key) 
        // {
        // if (key.hasOwnProperty(o)) 
        // {
        var sourceNode = {};
        sourceNode.text = key; //$('#nodeText').val();
        sourceNode.isFolder = true; //$('#nodeIsFolder').is(":checked");
        var targetId = $('#lstNodes :selected').val();
        // if(targetId=="")
        // {
        //     item_data["template"]["file-structure"][o]={};
        //     item_data["template"]["file-structure"][o]["type"]="folder";
        //     item_data["template"]["file-structure"][o]["content"]={};
        // }

        easytree.addNode(sourceNode, targetId);
        easytree.rebuildTree();
        loadSelectBox();
        //}

        // }   
    }
    var str = $('#lstNodes :selected').text();
    var n = str.search(" ");
//  var targetId = $('#lstNodes :selected').text().split(regex);
    //console.log(targetId);
    var targetId = $('#lstNodes :selected').text().substr(n+1);
    //console.log("targetId====="+targetId);

    iterate(item_data['template'], targetId, arr_select_folder_fid);
    loadTable(arr_non_select_folder,arr_select_folder_nonfid);
    // alert('hello');
}

function addNode1() {
    var arr_non_select_content = [];
    var arr_select_content = [];
    var arr_non_select_content_type = [];
    var arr_select_content_noncid=[];
    $('input:checkbox[name=checkboxContent]:checked').each(function() {
        // var split1=$(this).val().split('||::||~||::||');                         
        //var split1=$(this).val();                         
        var newElement = $(this).val();
        //var newElement = {};                    
        //newElement[split1[0]+'||::||~||::||'+split1[2]]=split1[1];
        arr_select_content.push(newElement);
        
    });
    //console.log(arr_select_content);

    $('input:checkbox[name=checkboxContent]:not(:checked)').each(function() {
        //var split2=$(this).val().split('||::||~||::||'); 
        var newElement3 = $(this).val();
        var newElement4 = $(this).attr('data-content-type');
        var newElement_noncid = $(this).attr('data-cid');
        // console.log(newElement4);
        arr_non_select_content_type.push(newElement4);
        arr_non_select_content.push(newElement3);
        arr_select_content_noncid(newElement_noncid);
    });
    // console.log(arr_non_select_content);
    var targetId1 = $('#lstNodes :selected').val();
    var allNodes = easytree.getAllNodes();
    if (allNodes.length == 0 && arr_select_content.length > 0) {
        alert("Please add at least one folder.");
    } else {
        for (var i = 0; i < arr_select_content.length; i++) {
            var key = arr_select_content[i];
            //console.log(key)
            //for (var o in key) 
            //{
            // if (key.hasOwnProperty(o)) 
            //{
            var sourceNode = {};
            sourceNode.text = key; //$('#nodeText').val();
            //sourceNode.id =o;//$('#nodeText').val();               
            sourceNode.isFolder = false; //$('#nodeIsFolder').is(":checked");
            easytree.addNode(sourceNode, targetId1);
            easytree.rebuildTree();
            loadSelectBox();
            //}
            //}
        }
        // iterate1(targetId1,arr_select_content);

        //var split_file=targetId1.split('||::||~||::||'); 
        loadTableContent(arr_non_select_content,
        arr_non_select_content_type,arr_select_content_noncid);
        var str = $('#lstNodes :selected').text();
    var n = str.search(" ");
//  var targetId = $('#lstNodes :selected').text().split(regex);
    //console.log(targetId);
    var targetId1 = $('#lstNodes :selected').text().substr(n+1);
        iterate1(item_data['template'],targetId1,arr_select_content_cid);
    }


}

function removeNodeX() {
    var result = confirm("are you sure to delete.?");
    if (result == true) {
        var currentlySelected = $('#lstNodes :selected').val();
        if (currentlySelected == "") {
            alert("Please select at least one node to be deleted.");
        } else {
            var node = easytree.getNode(currentlySelected);
            if (!node) {
                return;
            }
            easytree.removeNode(node.id);
            console.log("remove=" + node.id);
            easytree.rebuildTree();
            loadSelectBox();
            var arr = [];
            var arr1 = [];
            var newElement = {};
            var str1 = node.id;
            newElement[node.id] = node.text;
            arr.push(newElement);
            if (node.children) {
                for (var i = 0; i < node.children.length; i++) {
                    var newElement = {};
                    var str2 = node.children[i].id;
                    newElement[node.children[i].id] = node.children[i].text;
                    arr.push(newElement);
                }
            }
            preLoadFolderContentTable(arr);
            var str_remove;
            if (str1.indexOf("pp-folder") != -1) {
                str_remove = str1;
            } else if (str1.indexOf("pp-content") != -1) {
                var split = str1.split('||::||~||::||');
                str_remove = split[0];
            }
            removeJsonObj(item_data, str_remove);
        }
    }
}
// we have to reload selected box at the end of each function to ensure it is always up to date
function loadSelectBox() {
    var select = $('#lstNodes')[0];
    var currentlySelected = $('#lstNodes :selected').val();
    select.length = 0; // clear select box
    var root = new Option();
    root.text = 'Root';
    root.value = '';
    select.add(root);
    var allNodes = easytree.getAllNodes();
    addOptions(allNodes, select, '-', currentlySelected);

}

function addOptions(nodes, select, prefix, currentlySelected) {

    var i = 0;
    for (i = 0; i < nodes.length; i++) {
        var option = new Option();
        option.text = prefix + ' ' + nodes[i].text;
        option.value = nodes[i].id;
        option.selected = currentlySelected == nodes[i].id;
        select.add(option);
        if (nodes[i].children && nodes[i].children.length > 0) {
            addOptions(nodes[i].children, select, prefix + '-', currentlySelected);
        }
    }
}

var easytree = $('#demo_menu').easytree();
$(document).ready(function() {
    loadSelectBox();
});

function create_json_js() {
    //var item_data = $('#demo_menu').jstree(true).get_json('#', {flat:TRUE})
    var jsonString1 = JSON.stringify(item_data);
    alert(jsonString1);
    console.log(jsonString1);
    // document.getElementById("textareaJson").value = jsonString1;
}


// function stateChanged(nodes, nodesJson) {
//     var t = nodes[0].text;
//     $.cookie('demo_menu', nodesJson);
// }
// var easyTree = $('#demo_menu').easytree({
// data: $.cookie('demo_menu'),
// stateChanged: stateChanged
// });
</script>
{% endblock %}
